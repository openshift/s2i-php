#!/bin/bash

set -e

echo "---> Installing application source..."
cp -Rf /tmp/src/. ./

if [ -f composer.json ]; then
  echo "Found 'composer.json', installing dependencies using composer.phar ..."

  # Set timezone if not set
  if [ "$(cat $PHP_CONFIG | grep timezone | grep '^date\.timezone'; echo $?)" == "1" ]; then
	echo "Setting temporary timezone"
	cp -v $PHP_CONFIG /tmp/php.ini
	echo "date.timezone = GMT" >> $PHP_CONFIG
  fi

  # Install Composer
  php -r "readfile('https://getcomposer.org/installer');" | php

  # Install App dependencies using Composer
  ./composer.phar install --no-interaction --no-ansi --optimize-autoloader

  # Restore previous php.ini if exists
  if [ -f /tmp/php.ini ]; then
	echo "Restoring previous php.ini from /tmp/php.ini"
	mv -v /tmp/php.ini $PHP_CONFIG
  fi

  if [ ! -f composer.lock ]; then
    echo -e "\nConsider adding a 'composer.lock' file into your source repository.\n"
  fi
fi

# Fix source directory permissions
fix-permissions ./
